<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <title>Multi Line Chart</title>
    <script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://unpkg.com/d3-simple-slider"></script>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <style></style>
    <p style = "font-family:monospace; font-size:18px;" id="value">0</p>
    <div id="slider"></div>

    <script>
        var slider = d3
            .sliderHorizontal()
            .min(0)
            .max(53)
            .step(1)
            .width(300)
            .value(0)
            .displayValue(false)
            .on('onchange', (val) => {
                d3.select('#value').text(val.toFixed(0));
            });

        d3.select('#slider')
            .append('svg')
            .attr('width', 500)
            .attr('height', 100)
            .append('g')
            .attr('transform', 'translate(30,30)')
            .call(slider);
    </script>
    <button onclick="render()" type="button" class="filter-btn" id="filter" style = "font-family:monospace; font-size:14px">Highlight Top Outliers</button>

</head>
<body>
<div id="container" class="svg-container"></div>
<script>
    //------------------------1. PREPARATION------------------------//
    //-----------------------------SVG------------------------------//
    const width = 960;
    const height = 500;
    const margin = 5;
    const padding = 7;
    const adj = 30;
    // we are appending SVG first
    const svg = d3.select("div#container").append("svg")
        .attr("preserveAspectRatio", "xMinYMin meet")
        .attr("viewBox", "-"
            + adj + " -"
            + adj + " "
            + (width + adj *3) + " "
            + (height + adj*3))
        .style("padding", padding)
        .style("margin", margin)
        .classed("svg-content", true);

    // $(".filter-btn").on("click", function() {
    //     filterVal = document.getElementById("value").innerHTML
    //     render();
    // });

    function render() {

        //-----------------------------DATA-----------------------------//
        //const timeConv = d3.timeParse("%b-%Y");
        // const dataset = d3.csv("state_2.csv");
        // const ranking = d3.csv("rankings.csv");
        // dataset.then(function(data) {
        //     var slices = data.columns.slice(1).map(function(id) {
        //         return {
        //             id: id,
        //             values: data.map(function(d){
        //                 return {
        //                     step: d.step,
        //                     measurement: +d[id]
        //                 };
        //             }),
        //             rank: ???
        //         };
        //     });
        d3.csv("rankings_employment_perc.csv").then(ranks => {
            d3.csv("employment_perc2.csv").then(function (data) {
                var slices = data.columns.slice(1).map(function (id) {
                    return {
                        id: id,
                        values: data.map(function (d) {
                            return {
                                step: d.step,
                                measurement: +d[id]
                            };
                        }),
                        rank: +ranks.find(function (elem) {
                            return elem.id === id
                        }).rank
                    };
                });
                //})
                // Promise.all([d3.csv("state_2.csv"),d3.csv("rankings.csv")]).then([state_2,rankings]=>{
                //     var slices = state_2.columns.slice(1).map(funcion(id){
                //         return {
                //             id: id,
                //             values: state_2.map(funcion(d){
                //                 return {
                //                     step: d.step,
                //                     measurment: +d[id]
                //                 };
                //             }),
                //             rank: rankings.rank;
                //         };
                //     });


//----------------------------SCALES----------------------------//
                const xScale = d3.scaleLinear().range([0, width]);
                const yScale = d3.scaleLinear().rangeRound([height, 0]);
                //xScale.domain(d3.extent(data, function(d){
                //     return (d.step)}));
                xScale.domain([1, 252]);
                yScale.domain([d3.min(slices, function (c) {
                    return d3.min(c.values, function (d) {
                        return d.measurement - 2;
                    });
                }), d3.max(slices, function (c) {
                    return d3.max(c.values, function (d) {
                        return d.measurement + 2;
                    });
                })
                ]);

//-----------------------------AXES-----------------------------//
                const yaxis = d3.axisLeft()
                    //.ticks((slices[0].values).length)
                    .ticks(Math.round((((slices[0].values).length)) / 8))
                    //console.log(Math.round((((slices[0].values).length))/4))
                    .scale(yScale);

                const xaxis = d3.axisBottom()
                    //.ticks(10)
                    //.tickFormat(d3.timeFormat('%b %d'))
                    .scale(xScale);

//----------------------------LINES-----------------------------//
                const line = d3.line()
                    .x(function (d) {
                        return xScale(d.step);
                    })
                    .y(function (d) {
                        return yScale(d.measurement);
                    });

                let id = 0;
                const ids = function () {
                    return "line-" + id++;
                }
//-------------------------2. DRAWING---------------------------//
//-----------------------------AXES-----------------------------//
                svg.append("g")
                    .attr("class", "axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xaxis);

                svg.append("g")
                    .attr("class", "axis")
                    .call(yaxis)
                    .append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("dy", ".75em")
                    .attr("y", 6)
                    .style("text-anchor", "end");
                //.text("Frequency");

//----------------------------LINES-----------------------------//
                const lines = svg.selectAll("lines")
                    .data(slices)
                    .enter()
                    .append("g");

                lines.append("path")
                    .attr("class", ids)
                    .attr("fill", 'none')
                    //.attr("stroke", 'gray')
                    .attr("stroke", function (d) {
                        if (d.rank <= document.getElementById("value").innerHTML) {
                            return 'red'
                        } else {
                            return 'gray'
                        }

                    })
                    .attr("d", function (d) {
                        return line(d.values);
                    });

                lines.append("text")
                    .attr("class", "serie_label")
                    .datum(function (d) {
                        return {
                            id: d.id,
                            value: d.values[d.values.length - 1]
                        };
                    })
                    .attr("transform", function (d) {
                        return "translate(" + (xScale(d.value.step) + 10)
                            + "," + (yScale(d.value.measurement) ) + ")";
                    })
                    .attr("x", 5)
                    .text(function (d) {
                        return d.id;
                    });


            })
        });
    }
    render();
</script>
</body>

<!-- https://datawanderings.com/2019/10/28/tutorial-making-a-line-chart-in-d3-js-v-5/ -->
